{% extends "base.html" %}
{% block title %}Transacci칩n{% endblock %}
{% block content %}

<div class="card" style="max-width:820px;margin:auto;">
  <h2 style="margin-top:0;">{% if form.instance.pk %}Editar transacci칩n{% else %}Nueva transacci칩n{% endif %}</h2>

  <form method="post" id="txForm" class="grid">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <label>Cliente {{ form.cliente }}</label>

    <label>Tipo {{ form.tipo }}</label>

    <div id="campania-wrapper" style="display:none;">
      <label># Campa침a {{ form.campania }}</label>
      <small class="help">Visible solo si el tipo es "Natura".</small>
    </div>

    <div class="grid" style="gap:12px;margin-top:8px;">
      <label>Fecha {{ form.fecha }}</label>
      <!-- Hora oculta v칤a HiddenInput en el formulario -->
      {{ form.hora }}
    </div>

    <hr>

    {{ formset.management_form }}
    <div id="items-container" style="display:grid;gap:8px;">
      {% for f in formset.forms %}
        {% if forloop.counter0 == 0 %}
        <div class="item-row" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:8px;align-items:end;">
          <label>Producto {{ f.producto }}</label>
          <label>Precio U. {{ f.precio_unitario }}</label>
          <label>Cantidad {{ f.cantidad }}</label>
          <label>Descuento % {{ f.descuento }}</label>
          <div style="align-self:center;">
            {% if f.instance.pk %}<label style="display:flex;align-items:center;gap:6px;">Eliminar {{ f.DELETE }}</label>{% endif %}
          </div>
          {% for h in f.hidden_fields %}{{ h }}{% endfor %}
        </div>
        {% endif %}
      {% endfor %}
    </div>

    <button type="button" id="add-item" class="btn">+ producto</button>

    <hr>

    <!-- Totales en vivo -->
    <div class="grid" style="gap:6px;">
      <div><strong>Subtotal:</strong> $<span id="t-subtotal">0</span></div>
      <div><strong>Total descuento:</strong> $<span id="t-descuento">0</span></div>
      <div><strong>Valor a pagar:</strong> $<span id="t-pagar">0</span></div>
    </div>

    <div class="grid" style="gap:12px;margin-top:12px;">
      <div class="checkbox-line" style="display:flex;align-items:center;gap:10px;">
        {{ form.pagado }} <label for="id_pagado" style="margin:0;">Pagado</label>
      </div>
      <div style="font-size:12px;color:#666;">
        Si marcas <b>Pagado</b>, se registrar치 fecha y hora autom치ticas.
      </div>
    </div>

    <div style="margin-top:16px;">
      <button class="btn primary" type="submit">Guardar</button>
      <a class="btn" href="javascript:history.back()">Cancelar</a>
    </div>
  </form>
</div>

<script>
(function(){
  const NAT = "NAT";
  const tipoSel = document.getElementById("id_tipo");
  const campaniaWrap = document.getElementById("campania-wrapper");

  function toggleCampania(){
    if (!tipoSel) return;
    const v = tipoSel.value;
    campaniaWrap.style.display = (v === NAT) ? "block" : "none";
  }
  if (tipoSel){
    tipoSel.addEventListener("change", toggleCampania);
    toggleCampania();
  }

  const addBtn = document.getElementById("add-item");
  const container = document.getElementById("items-container");
  const totalForms = document.querySelector('input[name$="-TOTAL_FORMS"]');

  // Clonar SOLO la primera fila como plantilla
  function emptyRowTemplate(){
    const first = container.querySelector(".item-row");
    const clone = first.cloneNode(true);
    clone.querySelectorAll("input").forEach(inp => {
      if (inp.type === "checkbox") { inp.checked = false; }
      else { inp.value = ""; }
    });
    // Select de descuento: dejar sin seleccionar
    const sel = clone.querySelector('select[name$="descuento"]');
    if (sel) sel.selectedIndex = -1;
    // quitar DELETE si existe en la fila base
    const del = clone.querySelector('input[type="checkbox"][name$="DELETE"]');
    if (del) del.closest("label").remove();
    return clone;
  }

  function replaceIndex(el, from, to){
    if (el.name) el.name = el.name.replace(from, to);
    if (el.id) el.id = el.id.replace(from, to);
    if (el.htmlFor) el.htmlFor = el.htmlFor.replace(from, to);
  }

  if (addBtn){
    addBtn.addEventListener("click", function(){
      const formCount = parseInt(totalForms.value, 10);
      const newRow = emptyRowTemplate();
      newRow.querySelectorAll("input,select,label").forEach(el => {
        // 游녢 FIX: regex correcta (una sola barra)
        replaceIndex(el, /-\d+-/, `-${formCount}-`);
        replaceIndex(el, /__prefix__/, formCount);
      });
      container.appendChild(newRow);
      totalForms.value = formCount + 1;
      bindRow(newRow);
      calcTotals();
    });
  }

  // --------- C치lculo en vivo ---------
  const fmtMoney = (n) => (isFinite(n) ? new Intl.NumberFormat('es-CO').format(Math.max(n,0).toFixed(0)) : "0");

  function rowValues(row){
    const p = parseFloat((row.querySelector('input[name$="precio_unitario"]')?.value || "0").replace(",", ".")) || 0;
    const c = parseFloat((row.querySelector('input[name$="cantidad"]')?.value || "0").replace(",", ".")) || 0;
    const d = parseInt(row.querySelector('select[name$="descuento"]')?.value || "0", 10) || 0; // 10|20|30
    const base = p * c;
    const total = base * (1 - (d/100));
    return {base, total, desc: base - total};
  }

  function calcTotals(){
    let sub = 0, desc = 0, pagar = 0;
    container.querySelectorAll(".item-row").forEach(row => {
      const v = rowValues(row);
      sub += v.base;
      desc += v.desc;
      pagar += v.total;
    });
    document.getElementById("t-subtotal").textContent = fmtMoney(sub);
    document.getElementById("t-descuento").textContent = fmtMoney(desc);
    document.getElementById("t-pagar").textContent = fmtMoney(pagar);
  }

  function bindRow(row){
    const inputs = row.querySelectorAll('input[name$="precio_unitario"], input[name$="cantidad"], select[name$="descuento"]');
    inputs.forEach(el => el.addEventListener("input", calcTotals));
    inputs.forEach(el => el.addEventListener("change", calcTotals));
  }

  // Bind inicial SOLO a la primera fila que pintamos
  const firstRow = container.querySelector(".item-row");
  if (firstRow) bindRow(firstRow);
  calcTotals();
})();
</script>

<style>
.input{max-width:100%;}
.checkbox-line input[type="checkbox"]{ width:20px;height:20px;accent-color:#C07A57;cursor:pointer; }
.checkbox-line label{ font-weight:600;color:#333;cursor:pointer; }
</style>
{% endblock %}
