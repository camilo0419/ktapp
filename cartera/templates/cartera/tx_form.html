{% extends "base.html" %}
{% block title %}{% if form.instance.pk %}Editar transacción{% else %}Nueva transacción{% endif %}{% endblock %}
{% block content %}

<div class="card" style="max-width:820px;margin:auto;">
  <h2 style="margin-top:0;">{% if form.instance.pk %}Editar transacción{% else %}Nueva transacción{% endif %}</h2>

  <form method="post" id="txForm" class="grid">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Cliente -->
    <label>Cliente {{ form.cliente }}</label>
    {% if form.errors.cliente %}<small class="error">{{ form.errors.cliente.0 }}</small>{% endif %}

    <!-- Tipo -->
    <label>Tipo {{ form.tipo }}</label>
    {% if form.errors.tipo %}<small class="error">{{ form.errors.tipo.0 }}</small>{% endif %}

    <!-- Campaña (solo Natura) -->
    <div id="campania-wrapper" style="display:none;">
      <label># Campaña {{ form.campania }}</label>
      {% if form.errors.campania %}
        <small class="error">{{ form.errors.campania.0 }}</small>
      {% else %}
        <small class="help">Visible solo si el tipo es "Natura".</small>
      {% endif %}
    </div>

    <!-- Fecha -->
    <div class="grid" style="gap:12px;margin-top:8px;">
      <label>Fecha {{ form.fecha }}</label>
      {{ form.hora }} <!-- oculto por widget -->
      {% if form.errors.fecha %}<small class="error">{{ form.errors.fecha.0 }}</small>{% endif %}
    </div>

    <hr>

    <!-- Formset productos -->
    {{ formset.management_form }}
    {% if formset.non_form_errors %}
      <div class="error">{{ formset.non_form_errors }}</div>
    {% endif %}

    <div id="items-container" style="display:grid;gap:8px;">
      {% for f in formset.forms %}
        <div class="item-row" style="display:grid;grid-template-columns:1fr 2fr 1fr 1fr 1fr auto;gap:8px;align-items:end;">
          <label class="item-field item-code">Código {{ f.codigo_producto }}</label>
          {% if f.errors.codigo_producto %}<small class="error">{{ f.errors.codigo_producto.0 }}</small>{% endif %}

          <label class="item-field item-product">Producto {{ f.producto }}</label>
          {% if f.errors.producto %}<small class="error">{{ f.errors.producto.0 }}</small>{% endif %}

          <label class="item-field item-price">Precio U. {{ f.precio_unitario }}</label>
          {% if f.errors.precio_unitario %}<small class="error">{{ f.errors.precio_unitario.0 }}</small>{% endif %}

          <label class="item-field item-qty">Cantidad {{ f.cantidad }}</label>
          {% if f.errors.cantidad %}<small class="error">{{ f.errors.cantidad.0 }}</small>{% endif %}

          <label class="item-field item-disc">Descuento % {{ f.descuento }}</label>
          {% if f.errors.descuento %}<small class="error">{{ f.errors.descuento.0 }}</small>{% endif %}

          <div style="align-self:center;">
            {% if f.instance.pk %}
              <label style="display:flex;align-items:center;gap:6px;">Eliminar {{ f.DELETE }}</label>
            {% endif %}
          </div>

          {% for h in f.hidden_fields %}{{ h }}{% endfor %}
        </div>
      {% endfor %}
    </div>

    <button type="button" id="add-item" class="btn">+ producto</button>

    <hr>

    <!-- Totales -->
    <div class="grid" style="gap:6px;">
      <div><strong>Subtotal:</strong> $<span id="t-subtotal">0</span></div>
      <div><strong>Total descuento:</strong> $<span id="t-descuento">0</span></div>
      <div><strong>Valor a pagar:</strong> $<span id="t-pagar">0</span></div>
    </div>

    <!-- Pagado -->
    <div class="grid" style="gap:12px;margin-top:12px;">
      <div class="checkbox-line" style="display:flex;align-items:center;gap:10px;">
        {{ form.pagado }} <label for="id_pagado" style="margin:0;">Pagado</label>
      </div>
      <div style="font-size:12px;color:#666;">
        Si marcas <b>Pagado</b>, se registrará fecha y hora automáticas.
      </div>
    </div>

    <!-- ✅ Medio de pago (solo si Pagado) -->
    <div id="pago-wrap" class="card" style="display:none;margin-top:10px;background:rgba(220,208,194,.18);box-shadow:none;">
      <h3 style="margin:0 0 10px;">Medio de pago</h3>

      <div class="grid cols-2" style="gap:12px;">
        <label>Forma de pago
          <select class="input" name="metodo" id="id_metodo">
            <option value="NEQ">Nequi</option>
            <option value="BAN" selected>Bancolombia</option>
            <option value="EFE">Efectivo</option>
            <option value="CRU">Cruce de cuentas</option>
          </select>
        </label>

        <label>Fecha de pago
          <input class="input" type="date" name="fecha_pago" id="id_fecha_pago" value="">
        </label>

        <label>Hora
          <input class="input" type="time" name="hora_pago" id="id_hora_pago" value="">
        </label>

        <label>Notas (opcional)
          <input class="input" type="text" name="notas_pago" id="id_notas_pago" placeholder="Notas del pago">
        </label>
      </div>

      <div id="cruce-wrap" style="display:none;margin-top:10px;">
        <label>Descripción del cruce
          <input class="input" type="text" name="descripcion_cruce" id="id_descripcion_cruce" placeholder="Ej: Cruce con factura X / cuenta Y">
        </label>
      </div>

      <small class="help">* Estos datos solo se usan si marcas la transacción como pagada.</small>
    </div>

    <!-- Botones -->
    <div style="margin-top:16px;">
      <button class="btn primary" type="submit">Guardar</button>
      <a class="btn" href="javascript:history.back()">Cancelar</a>
    </div>
  </form>
</div>

<script>
(function(){
  // --- Mostrar campo campaña cuando el tipo es NATURA ---
  const NAT = "NAT";
  const tipoSel = document.getElementById("id_tipo");
  const campaniaWrap = document.getElementById("campania-wrapper");
  function toggleCampania(){
    if (!tipoSel) return;
    const v = tipoSel.value;
    campaniaWrap.style.display = (v === NAT) ? "block" : "none";
  }
  if (tipoSel){
    tipoSel.addEventListener("change", toggleCampania);
    toggleCampania();
  }

  // --- Dinámica de formset ---
  const addBtn = document.getElementById("add-item");
  const container = document.getElementById("items-container");
  const totalForms = document.querySelector('input[name$="-TOTAL_FORMS"]');

  function emptyRowTemplate(){
    const first = container.querySelector(".item-row");
    const clone = first.cloneNode(true);
    clone.querySelectorAll("input").forEach(inp => {
      if (inp.type === "checkbox") { inp.checked = false; }
      else { inp.value = ""; }
    });
    const sel = clone.querySelector('select[name$="descuento"]');
    if (sel) sel.value = "";
    const del = clone.querySelector('input[type="checkbox"][name$="DELETE"]');
    if (del) del.closest("label").remove();
    clone.querySelectorAll(".error").forEach(e => e.remove());
    return clone;
  }

  function replaceIndex(el, from, to){
    if (el.name) el.name = el.name.replace(from, to);
    if (el.id) el.id = el.id.replace(from, to);
    if (el.htmlFor) el.htmlFor = el.htmlFor.replace(from, to);
  }

  if (addBtn){
    addBtn.addEventListener("click", function(){
      const formCount = parseInt(totalForms.value, 10);
      const newRow = emptyRowTemplate();
      newRow.querySelectorAll("input,select,label").forEach(el => {
        replaceIndex(el, /-\d+-/, `-${formCount}-`);
        replaceIndex(el, /__prefix__/, formCount);
      });
      container.appendChild(newRow);
      totalForms.value = formCount + 1;
      bindRow(newRow);
      calcTotals();
    });
  }

  // --- Cálculos automáticos ---
  const fmtMoney = (n) => (isFinite(n) ? new Intl.NumberFormat('es-CO').format(Math.max(n,0).toFixed(0)) : "0");

  function rowValues(row){
    const p = parseFloat((row.querySelector('input[name$="precio_unitario"]')?.value || "0").replace(",", ".")) || 0;
    const c = parseFloat((row.querySelector('input[name$="cantidad"]')?.value || "0").replace(",", ".")) || 0;
    const d = parseInt(row.querySelector('select[name$="descuento"]')?.value || "0", 10) || 0;
    const base = p * c;
    const total = base * (1 - (d/100));
    return {base, total, desc: base - total};
  }

  function calcTotals(){
    let sub = 0, desc = 0, pagar = 0;
    container.querySelectorAll(".item-row").forEach(row => {
      const v = rowValues(row);
      sub += v.base;
      desc += v.desc;
      pagar += v.total;
    });
    document.getElementById("t-subtotal").textContent = fmtMoney(sub);
    document.getElementById("t-descuento").textContent = fmtMoney(desc);
    document.getElementById("t-pagar").textContent = fmtMoney(pagar);
  }

  function bindRow(row){
    const inputs = row.querySelectorAll('input[name$="precio_unitario"], input[name$="cantidad"], select[name$="descuento"]');
    inputs.forEach(el => el.addEventListener("input", calcTotals));
    inputs.forEach(el => el.addEventListener("change", calcTotals));
  }

  document.querySelectorAll("#items-container .item-row").forEach(bindRow);
  calcTotals();

  // ✅ Mostrar bloque de pago cuando marcan Pagado + defaults de fecha/hora
  const pagadoChk = document.getElementById("id_pagado");
  const pagoWrap = document.getElementById("pago-wrap");
  const metodo = document.getElementById("id_metodo");
  const cruce = document.getElementById("cruce-wrap");
  const fechaPago = document.getElementById("id_fecha_pago");
  const horaPago = document.getElementById("id_hora_pago");

  function syncCruce(){
    if(!metodo || !cruce) return;
    cruce.style.display = (metodo.value === "CRU") ? "block" : "none";
  }

  function ensureNow(){
    const d = new Date();
    if (fechaPago && !fechaPago.value) fechaPago.value = d.toISOString().slice(0,10);
    if (horaPago && !horaPago.value){
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      horaPago.value = `${hh}:${mm}`;
    }
  }

  function togglePagoWrap(){
    if(!pagadoChk || !pagoWrap) return;
    pagoWrap.style.display = pagadoChk.checked ? "block" : "none";
    if(pagadoChk.checked){
      ensureNow();
      syncCruce();
    }
  }

  if(pagadoChk){
    pagadoChk.addEventListener("change", togglePagoWrap);
    togglePagoWrap();
  }
  if(metodo){
    metodo.addEventListener("change", syncCruce);
  }
})();
</script>

<style>
.input{max-width:100%;}
.checkbox-line input[type="checkbox"]{ width:20px;height:20px;accent-color:#C07A57;cursor:pointer; }
.checkbox-line label{ font-weight:600;color:#333;cursor:pointer; }
.error{ color:#b00020; font-size:12px; }
.help{ color:#777; font-size:12px; }
</style>
{% endblock %}