{% extends "base.html" %}
{% load currency %}
{% block title %}{{ obj.nombre }} - KtApp{% endblock %}
{% block content %}

<div class="grid cols-2">
  <div class="card">
    <h2>{{ obj.nombre }}</h2>
    <p><small>{{ obj.telefono }}{% if obj.correo %} · {{ obj.correo }}{% endif %}</small></p>
    <p>Saldo pendiente total: <strong>{{ total_pendiente|cop }}</strong></p>
    <div class="row">
      <a class="btn" href="{% url 'cartera:tx_create' %}?cliente={{ obj.id }}">➕ Nueva transacción</a>
      <a class="btn alt" href="{% url 'cartera:clientes_update' obj.id %}">Editar</a>
    </div>
  </div>

  <div class="card">
    <h3>Resumen</h3>
    <p>Pendiente: <strong>{{ total_pendiente|cop }}</strong></p>
    <p>Pagado (monto facturado): <strong>{{ total_pagado|cop }}</strong></p>
    <p>Total transacciones: <strong>{{ tx_count }}</strong></p>
  </div>
</div>

<!-- ===== Desktop (tu tabla original) ===== -->
<div class="card hide-on-mobile">
  <table class="tx-table">
    <thead>
      <tr>
        <th class="w-date">Fecha</th>
        <th>Tipo</th>
        <th>Descripción</th>
        <th class="right">Valor</th>
        <th class="right">Abonado</th>
        <th class="right">Saldo</th>
        <th>Estado</th>
        <th class="w-actions">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for t in tx_list %}
      <tr>
        <td class="nowrap">{{ t.fecha|date:"Y-m-d" }}</td>
        <td>{{ t.get_tipo_display }}</td>

        <td>
          {% if t.descripcion %}<div>{{ t.descripcion }}</div>{% endif %}
          {% if t.items.all %}
            <div class="items-mini">
              {% for it in t.items.all %}
                <span class="chip">{{ it.cantidad|floatformat:0 }} × {{ it.producto }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </td>

        <td class="right money">{{ t.valor_a_pagar|cop }}</td>
        <td class="right money">{{ t.total_abonos|cop }}</td>
        <td class="right money">{{ t.saldo_actual|cop }}</td>

        <td>
          {% if t.pagado %}
            <span class="pill soft ok">Pagado</span>
          {% else %}
            <span class="pill soft warn">Pendiente</span>
          {% endif %}
        </td>

        <td class="actions-cell">
          <div class="actions">
            <a class="btn alt sm" href="{% url 'cartera:tx_detail' t.id %}">Ver</a>

            {% if not t.pagado %}
              <a class="btn alt sm" href="{% url 'cartera:tx_update' t.id %}">Editar</a>
              <a class="btn oxido sm js-paid" href="{% url 'cartera:tx_pagada' t.id %}">Marcar pagada</a>
            {% endif %}
          </div>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="8">Sin transacciones.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ===== Móvil (cards táctiles) ===== -->
<div class="card show-on-mobile">
  <h3 style="margin:0 0 10px;">Transacciones</h3>
  <div class="card-list">
    {% for t in tx_list %}
    <div class="touch-card touchable" data-href="{% url 'cartera:tx_detail' t.id %}">
      <div class="row">
        <div class="title">{{ t.get_tipo_display }}</div>
        <div class="right sub">{{ t.fecha|date:"Y-m-d" }}</div>
      </div>

      {% if t.items.all %}
      <div class="chips">
        {% for it in t.items.all %}
          <span class="chip">{{ it.cantidad|floatformat:0 }} × {{ it.producto }}</span>
        {% endfor %}
      </div>
      {% endif %}

      <div class="row" style="margin-top:8px;">
        <span class="k">Valor:</span>&nbsp;<span class="v">{{ t.valor_a_pagar|cop }}</span>
        <span class="k" style="margin-left:12px;">Abonado:</span>&nbsp;<span class="v">{{ t.total_abonos|cop }}</span>
        <span class="k" style="margin-left:auto;">Saldo:</span>&nbsp;<span class="v">{{ t.saldo_actual|cop }}</span>
      </div>

      <div class="row" style="margin-top:8px;">
        {% if t.pagado %}<span class="pill-ok">Pagado</span>{% else %}<span class="pill-warn">Pendiente</span>{% endif %}
        <span class="sub" style="margin-left:auto;">#{{ t.id }}</span>
      </div>

      <div class="cta-row">
        <a class="btn alt" href="{% url 'cartera:tx_detail' t.id %}">Ver</a>
        {% if not t.pagado %}
          <a class="btn cobre" href="{% url 'cartera:tx_update' t.id %}">Editar</a>
        {% endif %}
      </div>
    </div>
    {% empty %}
    <div class="touch-card">Sin transacciones.</div>
    {% endfor %}
  </div>
</div>

<style>
/* === Columnas base === */
.tx-table .w-date{ width:120px; }
.tx-table .nowrap{ white-space:nowrap; }
.tx-table td{ vertical-align:middle; }

/* Columna de Acciones: compacta y centrada */
.tx-table .w-actions{ width:160px; text-align:center; }
.actions-cell{ text-align:center; }
.actions{
  display:inline-flex; gap:6px; align-items:center; justify-content:center;
  flex-wrap:wrap; max-width:160px;
}

/* Botones compactos */
.btn.sm{ padding:6px 10px; font-size:12.5px; line-height:1.1; border-radius:8px; min-width:auto; }

/* Chips de productos (debajo de la descripción) */
.items-mini{ margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; }
.chip{
  display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px;
  color:#715C47; background:rgba(195,164,139,.20); border:1px solid rgba(195,164,139,.35);
}

/* Pills suaves (paleta) */
.pill.soft{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; }
.pill.soft.ok{ color:#2e5b3a; background:rgba(113,92,71,0.10); border:1px solid rgba(113,92,71,0.18); }
.pill.soft.warn{ color:#7a2315; background:rgba(171,66,38,0.10); border:1px solid rgba(171,66,38,0.18); }

/* Dinero */
.right{ text-align:right; }
.money{ font-weight:500; color:#3c3c3c; font-size:14px; }

/* Botones con paleta */
.btn.cobre{ background:#CC845E; color:#fff; }
.btn.oxido{ background:#AB4226; color:#fff; }
.btn:disabled{ opacity:.55; cursor:not-allowed; }
</style>

<script>
(function(){
  // Confirmación al marcar pagada (en la tabla desktop)
  document.querySelectorAll('.js-paid').forEach(a=>{
    a.addEventListener('click', function(e){
      if(!confirm('¿Confirmas marcar esta transacción como PAGADA?')) e.preventDefault();
    });
  });
})();
</script>

{% endblock %}
