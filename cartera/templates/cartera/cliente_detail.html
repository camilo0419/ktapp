{% extends "base.html" %}
{% load currency %}
{% block title %}{{ obj.nombre }} - KtApp{% endblock %}
{% block content %}

<!-- ===== Cabecera cliente + Resumen (igual) ===== -->
<div class="grid cols-2">
  <div class="card">
    <h2 style="margin:0 0 4px;">{{ obj.nombre }}</h2>
    <p style="margin:0 0 8px;"><small>{{ obj.telefono }}{% if obj.correo %} ¬∑ {{ obj.correo }}{% endif %}</small></p>
    <p style="margin:0 0 12px;">Saldo pendiente total: <strong>{{ total_pendiente|cop }}</strong></p>
    <div class="row" style="gap:8px;flex-wrap:wrap;">
      <a class="btn cobre" href="{% url 'cartera:tx_create' %}?cliente={{ obj.id }}">‚ûï Transacci√≥n</a>
      <a class="btn cobre outline" href="{% url 'cartera:pago_lote' obj.id %}">üí≥ Registrar pago</a>
      <a class="btn alt" href="{% url 'cartera:clientes_update' obj.id %}">Editar</a>
      <a href="{% url 'cartera:estado_cuenta' obj.id %}" class="btn cobre outline" style="width:100%;text-align:center;">
        üìÑ Generar estado de cuenta
      </a>

    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Resumen</h3>
    <p style="margin:.2rem 0;">Pendiente: <strong>{{ total_pendiente|cop }}</strong></p>
    <p style="margin:.2rem 0;">Pagado (monto facturado): <strong>{{ total_pagado|cop }}</strong></p>
    <p style="margin:.2rem 0;">Total transacciones: <strong>{{ tx_count }}</strong></p>
  </div>
</div>

<!-- ===== Desktop (tabla original) ===== -->
<div class="card hide-on-mobile">
  <table class="tx-table">
    <thead>
      <tr>
        <th class="w-date">Fecha</th>
        <th>Tipo</th>
        <th>Descripci√≥n</th>
        <th class="right">Valor</th>
        <th class="right">Abonado</th>
        <th class="right">Saldo</th>
        <th>Estado</th>
        <th class="w-actions">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for t in tx_list %}
      <tr>
        <td class="nowrap">{{ t.fecha|date:"Y-m-d" }}</td>
        <td>{{ t.get_tipo_display }}</td>

        <td>
          {% if t.descripcion %}<div>{{ t.descripcion }}</div>{% endif %}
          {% if t.items.all %}
            <div class="items-mini">
              {% for it in t.items.all %}
                <span class="chip">{{ it.cantidad|floatformat:0 }} √ó {{ it.producto }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </td>

        <td class="right money">{{ t.valor_a_pagar|cop }}</td>
        <td class="right money">{{ t.total_abonos|cop }}</td>
        <td class="right money">{{ t.saldo_actual|cop }}</td>

        <td>
          {% if t.pagado %}
            <span class="pill soft ok">Pagado</span>
          {% else %}
            <span class="pill soft warn">Pendiente</span>
          {% endif %}
        </td>

        <td class="actions-cell">
          <div class="actions">
            <a class="btn alt sm" href="{% url 'cartera:tx_detail' t.id %}">Ver</a>
            {% if not t.pagado %}
              <a class="btn alt sm" href="{% url 'cartera:tx_update' t.id %}">Editar</a>
              <a class="btn oxido sm js-paid" href="{% url 'cartera:tx_pagada' t.id %}">Marcar pagada</a>
            {% endif %}
          </div>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="8">Sin transacciones.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ===== M√≥vil (cards mejoradas estilo AcarreApp) ===== -->
<div class="card show-on-mobile">
  <h3 style="margin:0 0 10px;">Transacciones</h3>
  <div class="card-list">
    {% for t in tx_list %}
    <article class="tx-card touch-card">
      <!-- Encabezado -->
      <div class="tx-head">
        <div class="tx-title">
          {{ t.get_tipo_display }}{% if t.campania %} ¬∑ <span class="sub">Campa√±a {{ t.campania }}</span>{% endif %}
        </div>
        <div class="tx-date sub">{{ t.fecha|date:"Y-m-d" }}</div>
      </div>

      <!-- Chips de productos -->
      {% if t.items.all %}
      <div class="chips">
        {% for it in t.items.all %}
          <span class="chip">{{ it.cantidad|floatformat:0 }} √ó {{ it.producto }}</span>
        {% endfor %}
      </div>
      {% endif %}

      <!-- M√©tricas 3 columnas -->
      <div class="metrics">
        <div><span>Valor</span><strong>{{ t.valor_a_pagar|cop }}</strong></div>
        <div><span>Abonado</span><strong>{{ t.total_abonos|cop }}</strong></div>
        <div><span>Saldo</span><strong>{{ t.saldo_actual|cop }}</strong></div>
      </div>

      <!-- Estado + ID -->
      <div class="row" style="margin-top:8px;">
        {% if t.pagado %}
          <span class="pill-ok">Pagado</span>
          {% if t.fecha_pago %}<span class="sub" style="margin-left:8px;">({{ t.fecha_pago|date:"Y-m-d" }})</span>{% endif %}
        {% else %}
          <span class="pill-warn">Pendiente</span>
        {% endif %}
        <span class="sub" style="margin-left:auto;">#{{ t.id }}</span>
      </div>

      <!-- CTA -->
      <div class="cta-row two">
        <a class="btn alt" href="{% url 'cartera:tx_detail' t.id %}">Ver</a>
        {% if not t.pagado %}
          <a class="btn cobre" href="{% url 'cartera:tx_update' t.id %}">Editar</a>
        {% endif %}
      </div>
    </article>
    {% empty %}
      <div class="touch-card">Sin transacciones.</div>
    {% endfor %}
  </div>
</div>

<style>
/* ===== tabla desktop (igual) ===== */
.tx-table .w-date{ width:120px; }
.tx-table .nowrap{ white-space:nowrap; }
.tx-table td{ vertical-align:middle; }
.tx-table .w-actions{ width:160px; text-align:center; }
.actions-cell{ text-align:center; }
.actions{ display:inline-flex; gap:6px; align-items:center; justify-content:center; flex-wrap:wrap; max-width:160px; }
.btn.sm{ padding:6px 10px; font-size:12.5px; line-height:1.1; border-radius:8px; min-width:auto; }
.items-mini{ margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; }
.chip{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; color:#715C47; background:rgba(195,164,139,.20); border:1px solid rgba(195,164,139,.35); }
.pill.soft{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; }
.pill.soft.ok{ color:#2e5b3a; background:rgba(113,92,71,0.10); border:1px solid rgba(113,92,71,0.18); }
.pill.soft.warn{ color:#7a2315; background:rgba(171,66,38,0.10); border:1px solid rgba(171,66,38,0.18); }
.right{ text-align:right; }
.money{ font-weight:500; color:#3c3c3c; font-size:14px; }

/* ===== cards m√≥vil mejoradas ===== */
.tx-card .metrics{
  margin-top:10px;
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
}
.tx-card .metrics div{
  background:#f8f4f0;
  border:1px solid #eadfd4;
  border-radius:12px;
  padding:8px 10px;
}
.tx-card .metrics span{
  display:block;
  font-size:11.5px;
  color:#6b6055;
  margin-bottom:2px;
}
.tx-card .metrics strong{
  font-size:15px;
  color:#1e1a16;
}
.cta-row.two{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:12px; }

/* ===== FIX m√≥vil: evitar ‚Äúcortes‚Äù y desbordes ===== */
.show-on-mobile .card-list { display:flex; flex-direction:column; gap:12px; }

/* header de cada card */
.tx-head{
  display:flex;
  gap:10px;
  align-items:flex-start;
}
.tx-title{
  font-weight:800;
  font-size:20px;
  line-height:1.1;
  min-width:0;           /* clave para que permita wrap */
  flex:1 1 auto;
  word-break:break-word; /* rompe palabras largas */
}
.tx-date{
  flex:0 0 auto;
  white-space:nowrap;
  font-size:13px;
}

/* chips: que siempre bajen y no empujen el ancho */
.chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
.chip{
  max-width:100%;
  white-space:normal;
  word-break:break-word;
  line-height:1.15;
}

/* m√©tricas: en m√≥vil mejor 2 columnas */
@media (max-width: 420px){
  .tx-card .metrics{
    grid-template-columns: repeat(2, 1fr);
  }
}

/* CTA: botones siempre del mismo alto y sin deformarse */
.cta-row.two{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:12px;
}
.cta-row.two .btn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:12px 12px;
  border-radius:14px;
  min-height:44px;
}

/* ‚ÄúVer / Editar‚Äù no se deben encoger */
.cta-row.two .btn{ flex:0 0 auto; }

/* por si alg√∫n contenedor genera scroll horizontal */
.show-on-mobile, .tx-card { overflow:hidden; }


</style>

<script>
(function(){
  // Confirmaci√≥n al marcar pagada (solo si hay enlace en tabla)
  document.querySelectorAll('.js-paid').forEach(a=>{
    a.addEventListener('click', function(e){
      if(!confirm('¬øConfirmas marcar esta transacci√≥n como PAGADA?')) e.preventDefault();
    });
  });
})();
</script>

{% endblock %}
